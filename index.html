<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>q-chunk</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --border: #1e1e2e;
      --text: #e4e4ef;
      --muted: #6b6b7b;
      --accent: #00ffc8;
      --q: #ff6b9d;
      --chunk: #00ffc8;
      --pending: #2a2a3a;
      --running: #fbbf24;
      --done: #34d399;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    main { max-width: 1200px; margin: 0 auto; padding: 3rem 2rem; }
    header { text-align: center; margin-bottom: 4rem; }
    h1 { font-size: 3rem; font-weight: 600; background: linear-gradient(135deg, var(--accent), var(--q)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { color: var(--muted); font-size: 1.1rem; }
    .controls { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; display: flex; gap: 2rem; flex-wrap: wrap; align-items: center; }
    label { font-size: 0.9rem; color: var(--muted); display: flex; align-items: center; gap: 0.75rem; }
    input[type="range"] { width: 100px; accent-color: var(--accent); }
    input[type="number"] { width: 55px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; padding: 0.4rem; color: var(--text); font-family: 'JetBrains Mono', monospace; }
    button { font-family: inherit; font-weight: 600; padding: 0.6rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
    .btn-run { background: var(--accent); color: var(--bg); }
    .btn-run:hover:not(:disabled) { transform: translateY(-2px); }
    .btn-run:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-reset { background: var(--border); color: var(--text); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.5rem; position: relative; }
    .panel::before { content: ''; position: absolute; inset: 0 0 auto 0; height: 3px; background: var(--color); border-radius: 8px 8px 0 0; }
    .panel-head { display: flex; justify-content: space-between; margin-bottom: 1rem; }
    .panel-title { font-family: 'JetBrains Mono', monospace; color: var(--color); display: flex; align-items: center; gap: 0.5rem; }
    .panel-title::before { content: ''; width: 8px; height: 8px; border-radius: 50%; background: var(--color); }
    .time { font-family: 'JetBrains Mono', monospace; color: var(--muted); }
    .tasks { display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 120px; align-content: flex-start; }
    .task { width: 40px; height: 40px; border-radius: 6px; background: var(--pending); display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--muted); transition: all 0.3s; }
    .task[data-state="running"] { background: var(--running); color: var(--bg); animation: pulse 0.6s infinite; box-shadow: 0 0 20px var(--running); }
    .task[data-state="done"] { background: var(--done); color: var(--bg); animation: pop 0.3s; }
    @keyframes pulse { 50% { transform: scale(1.1); } }
    @keyframes pop { 0% { transform: scale(1.3); } }
    .console { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .console-bar { display: flex; gap: 0.5rem; padding: 0.75rem 1rem; background: var(--bg); border-bottom: 1px solid var(--border); }
    .dot { width: 12px; height: 12px; border-radius: 50%; }
    .dot:nth-child(1) { background: #ff5f57; }
    .dot:nth-child(2) { background: #febc2e; }
    .dot:nth-child(3) { background: #28c840; }
    .console-out { padding: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; max-height: 280px; overflow-y: auto; line-height: 1.8; }
    .log { display: flex; gap: 0.75rem; }
    .log-t { color: var(--muted); }
    .log-q { color: var(--q); }
    .log-c { color: var(--chunk); }
    .log-i { color: var(--muted); }
    .log-s { color: var(--done); }
    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border); text-align: center; }
    .stat-label { font-size: 0.8rem; color: var(--muted); }
    .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 600; }
    .stat-value.q { color: var(--q); }
    .stat-value.c { color: var(--chunk); }
    [hidden] { display: none !important; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>q-chunk</h1>
      <p class="subtitle">Queue & chunk your promises</p>
    </header>

    <div class="controls">
      <label>Tasks <input type="range" id="count" min="4" max="24" value="12" oninput="this.nextElementSibling.value=this.value"><input type="number" min="4" max="24" value="12" oninput="this.previousElementSibling.value=this.value"></label>
      <label>Chunk <input type="range" id="size" min="1" max="12" value="4" oninput="this.nextElementSibling.value=this.value"><input type="number" min="1" max="12" value="4" oninput="this.previousElementSibling.value=this.value"></label>
      <label>Delay <input type="number" id="delay" min="100" max="2000" step="100" value="300">ms</label>
      <button class="btn-run" onclick="run()">Run Demo</button>
      <button class="btn-reset" onclick="reset()">Reset</button>
    </div>

    <div class="grid">
      <section class="panel" style="--color: var(--q)">
        <div class="panel-head">
          <span class="panel-title">q()</span>
          <span class="time" id="time-q">--</span>
        </div>
        <div class="tasks" id="tasks-q"></div>
      </section>
      <section class="panel" style="--color: var(--chunk)">
        <div class="panel-head">
          <span class="panel-title">chunk()</span>
          <span class="time" id="time-c">--</span>
        </div>
        <div class="tasks" id="tasks-c"></div>
      </section>
    </div>

    <div class="console">
      <div class="console-bar"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
      <div class="console-out" id="out"></div>
      <div class="stats" id="stats" hidden>
        <div><div class="stat-label">q() time</div><div class="stat-value q" id="stat-q"></div></div>
        <div><div class="stat-label">chunk() time</div><div class="stat-value c" id="stat-c"></div></div>
      </div>
    </div>
  </main>

  <script type="module">
    import { q, chunk } from './src/q-chunk.js'

    const $ = id => document.getElementById(id)
    const val = id => +$(id).value
    let running = false

    const renderTasks = (id, n) => {
      $(id).innerHTML = Array.from({ length: n }, (_, i) =>
        `<div class="task" data-i="${i}">${i + 1}</div>`
      ).join('')
    }

    const setTaskState = (id, i, state) =>
      $(id).querySelector(`[data-i="${i}"]`)?.setAttribute('data-state', state)

    const log = (msg, cls = 'i') => {
      const t = new Date().toLocaleTimeString('en-US', { hour12: false })
      $('out').innerHTML += `<div class="log"><span class="log-t">${t}</span><span class="log-${cls}">${msg}</span></div>`
      $('out').scrollTop = $('out').scrollHeight
    }

    const reset = () => {
      const n = val('count')
      renderTasks('tasks-q', n)
      renderTasks('tasks-c', n)
      $('time-q').textContent = $('time-c').textContent = '--'
      $('out').innerHTML = ''
      $('stats').hidden = true
    }

    const run = async () => {
      if (running) return
      running = true
      document.querySelector('.btn-run').disabled = true

      const [n, size, delay] = [val('count'), val('size'), val('delay')]
      reset()
      log(`Starting: ${n} tasks, chunk=${size}, delay=${delay}ms`, 'i')

      const makeTasks = (container, type) =>
        Array.from({ length: n }, (_, i) => async () => {
          setTaskState(container, i, 'running')
          log(`${type}: task ${i + 1} started`, type === 'q' ? 'q' : 'c')
          await new Promise(r => setTimeout(r, delay))
          setTaskState(container, i, 'done')
          log(`${type}: task ${i + 1} done`, type === 'q' ? 'q' : 'c')
          return i + 1
        })

      log('--- q() ---', 'i')
      const t0 = performance.now()
      await q(makeTasks('tasks-q', 'q'))
      const qMs = Math.round(performance.now() - t0)
      $('time-q').textContent = `${qMs}ms`
      log(`q() done in ${qMs}ms`, 's')

      log(`--- chunk(fns, ${size}) ---`, 'i')
      const t1 = performance.now()
      await chunk(makeTasks('tasks-c', 'chunk'), size)
      const cMs = Math.round(performance.now() - t1)
      $('time-c').textContent = `${cMs}ms`
      log(`chunk() done in ${cMs}ms`, 's')

      $('stat-q').textContent = `${qMs}ms`
      $('stat-c').textContent = `${cMs}ms`
      $('stats').hidden = false
      log(`chunk() was ${(qMs / cMs).toFixed(1)}x faster!`, 's')

      running = false
      document.querySelector('.btn-run').disabled = false
    }

    Object.assign(window, { run, reset })
    reset()
    log('Ready. Click "Run Demo" to start.', 'i')
  </script>
</body>
</html>
